# Package Configuration Style Guide

## Overview

Package configuration files define metadata, dependencies, exports, and build settings. In editable (an R package using Golem):
- `DESCRIPTION` — Package metadata and dependencies
- `NAMESPACE` — Exported functions and imports
- `editable.Rproj` — RStudio project settings
- `renv/` — Dependency management (optional, recommended for reproducibility)

## File Convention

**Package Metadata**: `DESCRIPTION` (required)
**Exports/Imports**: `NAMESPACE` (auto-generated from @export roxygen, rarely manual edit)
**Configuration Files**: `golem-config.yml`, `_devops.yml` (future)

## DESCRIPTION Pattern

```r
Package: editable
Title: Pharmaceutical Data Editor - Interactive Table Editing for Clinical Trials
Version: 0.1.0
Authors@R: 
    person(
      "Your", "Name",
      email = "your.email@example.com",
      role = c("aut", "cre"),
      comment = c(ORCID = "0000-0000-0000-0000")
    )
Maintainer: Your Name <your.email@example.com>
Description: 
    Interactive table editing application for pharmaceutical research data.
    Provides single-dataset editing with DuckDB persistence, real-time validation,
    and immutable change tracking. Targets regulatory compliance in clinical trial
    data management.
License: MIT + file LICENSE
Encoding: UTF-8
Language: en-US
URL: https://github.com/yourusername/editable
BugReports: https://github.com/yourusername/editable/issues
Repository: github
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.2.3
Depends: 
    R (>= 4.1)
Imports:
    ## Core Shiny framework
    shiny (>= 1.8.0),
    bslib (>= 0.5.0),
    shinyjs (>= 2.1.0),
    
    ## State management & validation
    R6 (>= 2.5.1),
    checkmate (>= 2.2.0),
    cli (>= 3.6.0),
    
    ## Data persistence
    DBI (>= 1.1.3),
    duckdb (>= 0.8.0),
    
    ## HTMLwidgets
    htmlwidgets (>= 1.6.0),
    
    ## Development utilities
    rlang (>= 1.1.0),
    glue (>= 1.6.0)
Suggests:
    ## Testing
    testthat (>= 3.1.0),
    shinytest2 (>= 0.1.0),
    
    ## Documentation & development
    roxygen2 (>= 7.2.0),
    devtools (>= 2.4.0),
    renv (>= 0.16.0),
    
    ## Performance profiling (development only)
    profvis (>= 0.3.7),
    shiny.profiles (>= 0.0.4)
```

**Rules:**
- Version format: `X.Y.Z` (semantic versioning)
- Title: <65 characters, clear domain (pharmaceutical, clinical trials)
- Description: 1-5 sentences, specific problem addressed, not generic
- License: `MIT + file LICENSE` (copy MIT license to LICENSE file)
- Authors: Include ORCID, use `cre` (creator/maintainer contact)
- Roxygen2: Enable markdown in roxygen comments
- Depends: Minimum R version tested against
- Imports: Only packages actually used (strict)
- Suggests: Testing, documentation, optional features

### Import Organization

Group imports by concern:
```
## Framework (big dependencies first)
shiny, bslib, htmlwidgets

## Domain-specific (validation, state, persistence)
R6, checkmate, cli, DBI, duckdb

## Utilities (helpers, glue, rlang)
glue, rlang, etc.
```

## NAMESPACE Pattern

**Do NOT manually edit NAMESPACE.** Instead, use roxygen2 @export:

### Example Function Export

```r
#' Run Application
#'
#' @export
run_app <- function() { }

#' Shiny Module Output
#'
#' @export
hotwidget_output <- function() { }

#' Shiny Module Renderer
#'
#' @export
render_hotwidget <- function() { }
```

**Auto-generated NAMESPACE:**

```r
# Generated by roxygen2: do not edit by hand

export(hotwidget)
export(hotwidget_output)
export(render_hotwidget)
export(run_app)
import(shiny)
importFrom(DBI,dbConnect)
importFrom(DBI,dbReadTable)
importFrom(checkmate,assert_character)
importFrom(checkmate,assert_data_frame)
importFrom(checkmate,assert_directory_exists)
importFrom(checkmate,assert_file_exists)
importFrom(checkmate,assert_integerish)
importFrom(checkmate,assert_logical)
importFrom(cli,cli_abort)
importFrom(cli,cli_inform)
importFrom(cli,cli_warn)
importFrom(duckdb,duckdb)
importFrom(htmlwidgets,createWidget)
importFrom(htmlwidgets,shinyRenderWidget)
importFrom(htmlwidgets,shinyWidgetOutput)
importFrom(rlang,"%||%")
importFrom(shiny,NS)
importFrom(shiny,fluidPage)
importFrom(shiny,observeEvent)
importFrom(shiny,reactive)
importFrom(shiny,reactiveVal)
```

**Rules:**
- Use @importFrom for specific functions (not entire packages)
- Use @import only for packages you use extensively (shiny, R6, etc.)
- Roxygen2 auto-generates from code; regenerate after adding @export
- Command: `devtools::document()` or `roxygen2::roxygenise()`

## Roxygen Configuration

### _devtools.yml (Development Settings)

```yaml
# Create this if customizing development workflow
document_extensions: "R"
run_examples: no  # Skip running @examples during check
```

### Load Early in Session

In `.Rprofile` (project root):

```r
# .Rprofile - Local development only
if (file.exists(".Rprofile.local")) {
  source(".Rprofile.local")
}

# Attach project for interactive use
if (rstudioapi::isAvailable()) {
  rstudioapi::documentNew()
  pkgload::load_all()
  cat("Loaded editable with load_all()\n")
}
```

## Golem Configuration

### golem-config.yml Pattern

```yaml
default:
  golem_name: editable
  golem_version: 0.1.0
  app_prod: no
  app_ref: !expr golem::get_golem_options("golem_ref")
  golem_wd: !expr golem::pkg_tools_get_wd()
  
production:
  app_prod: yes
  
dev:
  app_prod: no
  debug: yes
```

**Pattern:**
- `default`: Settings for all environments
- `production`: Override defaults for prod deployment
- `dev`: Override defaults for development
- Access via: `get_golem_options("setting_name")`

## Dependency Management with renv

### renv.lock Pattern

Auto-generated by renv, DO NOT manually edit:

```json
{
  "R": {
    "Version": "4.3.2",
    "Repositories": [
      {
        "Name": "CRAN",
        "URL": "https://cloud.r-project.org"
      }
    ]
  },
  "Packages": {
    "shiny": {
      "Package": "shiny",
      "Version": "1.8.0",
      "Source": "Repository",
      "Repository": "CRAN",
      "Hash": "abc123"
    },
    "editable": {
      "Package": "editable",
      "Version": "0.1.0",
      "Source": "Local",
      "Path": "."
    }
  }
}
```

**Setup:**

```r
# Initial setup
renv::init()  # Creates renv/ and renv.lock

# After adding new dependency
# Edit DESCRIPTION, then:
renv::snapshot()  # Locks all packages to renv.lock

# On new machine/session
renv::restore()  # Installs locked versions
```

**Rules:**
- Commit renv.lock to git (ensures reproducibility)
- renv/ folder: usually gitignored (generated files)
- Run `renv::snapshot()` after dependency changes
- Run `renv::restore()` on new/CI environment

## RStudio Project Settings

### editable.Rproj

```ini
Version: 1.0

RestoreWorkspace: No
SaveWorkspace: No
AlwaysSaveHistory: Default

EnableCodeIndexing: Yes
UseSpacesForTab: Yes
NumSpacesForTab: 2
Encoding: UTF-8

RnwWeave: Sweave
LaTeXProgram: pdfLaTeX

AutoAppendNewline: Yes
StripTrailingWhitespace: Yes

BuildType: Package
PackageUseDevtools: Yes
PackageInstallArgs: --no-multiarch --with-keep.source
PackageRoxygenize: rd,collate,namespace,vignette
```

**Rules:**
- Don't restore workspace (ensure reproducible startup)
- Enable code indexing (IDE syntax highlighting)
- Use 2-space indentation (R standard)
- Auto-document with roxygen (on build)
- Commit to git (team consistency)

## Pre-commit Hooks (Optional, Recommended)

### .pre-commit-config.yaml

```yaml
repos:
  - repo: local
    hooks:
      - id: roxygen2
        name: Roxygen2 documentation
        entry: Rscript -e "roxygen2::roxygenise()"
        language: system
        types: [r]
        stages: [commit]
        pass_filenames: false
        
      - id: lintr
        name: Lint R code
        entry: Rscript -e "lintr::lint_dir('R')"
        language: system
        types: [r]
        
      - id: styler
        name: Format R code
        entry: Rscript -e "styler::style_file(commandArgs(trailingOnly=TRUE))"
        language: system
        types: [r]
        pass_filenames: true
```

**Usage:**

```bash
# Install pre-commit
pip install pre-commit

# Set up hooks
pre-commit install

# Run manually
pre-commit run --all-files
```

## LICENSE File

### LICENSE (MIT Template)

```
MIT License

Copyright (c) 2024 [Your Name/Organization]

Permission is hereby granted, free of charge, to any person obtaining 
a copy of this software and associated documentation files (the 
"Software"), to deal in the Software without restriction, including 
without limitation the rights to use, copy, modify, merge, publish, 
distribute, sublicense, and/or sell copies of the Software, and to 
permit persons to whom the Software is furnished to do so, subject 
to the following conditions:

The above copyright notice and this permission notice shall be included 
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS 
OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL 
THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR 
OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, 
ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR 
OTHER DEALINGS IN THE SOFTWARE.
```

## Documentation Generation

### Set Roxygen2 Options

In `R/zzz.R` (package initialization):

```r
#' @keywords internal
"_PACKAGE"

## usethis namespace: start
#' @import shiny
#' @import R6
#' @importFrom cli cli_abort cli_inform cli_warn
#' @importFrom checkmate assert_character assert_integerish assert_data_frame
#' @importFrom DBI dbConnect dbReadTable dbExecute
#' @importFrom duckdb duckdb
#' @importFrom htmlwidgets createWidget shinyWidgetOutput shinyRenderWidget
#' @importFrom rlang "%||%"
## usethis namespace: end
NULL
```

### Generate Documentation

```bash
# Command line
R CMD check .          # Full package check
roxygen2::roxygenise() # Update NAMESPACE + man/
devtools::document()   # Same as roxygen2::roxygenise()
```

## Typical Development Workflow

```r
# 1. Add new function
# R/new_function.R with @export roxygen

# 2. Update documentation
devtools::document()

# 3. Load package
devtools::load_all()

# 4. Update dependencies
# Edit DESCRIPTION, then:
renv::snapshot()

# 5. Run tests
devtools::test()

# 6. Check package
devtools::check()

# 7. Build & submit to CRAN
devtools::release()
```

## Summary

Package configuration defines:

1. **Metadata** (DESCRIPTION):
   - Package purpose, version, author
   - Explicit dependency list (imports, suggests)
   - Roxygen2 settings for auto-generation

2. **Exports** (NAMESPACE):
   - What users can call (generated from @export)
   - What packages you import
   - Never manually edit (use roxygen)

3. **Project Settings** (Rproj):
   - RStudio build configuration
   - Editing preferences (spaces, encoding)
   - Roxygen auto-documentation on build

4. **Dependency Lock** (renv.lock):
   - Reproducible environments
   - Snapshot after DESCRIPTION changes
   - Restore on new installations

Key principle: **Configuration centralizes project metadata; roxygen2 auto-generates from code.**
